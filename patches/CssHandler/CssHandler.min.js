"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _matchClass(t,e){if(t&&t.length&&e&&e.length){if(1==t.length&&1==e.length)return t[0]==e[0];if(t.length<e.length)return!1;var n=!0,r=!1,s=void 0;try{for(var i,a=e[Symbol.iterator]();!(n=(i=a.next()).done);n=!0){var l=i.value,h=!1,o=!0,u=!1,c=void 0;try{for(var d,f=t[Symbol.iterator]();!(o=(d=f.next()).done);o=!0){d.value==l&&(h=!0)}}catch(t){u=!0,c=t}finally{try{!o&&f.return&&f.return()}finally{if(u)throw c}}if(0==h)return!1}}catch(t){r=!0,s=t}finally{try{!n&&a.return&&a.return()}finally{if(r)throw s}}return!0}return!1}function _matchId(t,e){if(!(t&&t.length&&e&&e.length))return!1;if(1==t.length&&1==e.length)return t[0]==e[0];if(t.length<e.length)return!1;var n=!0,r=!1,s=void 0;try{for(var i,a=e[Symbol.iterator]();!(n=(i=a.next()).done);n=!0){var l=i.value,h=!1,o=!0,u=!1,c=void 0;try{for(var d,f=t[Symbol.iterator]();!(o=(d=f.next()).done);o=!0){d.value==l&&(h=!0)}}catch(t){u=!0,c=t}finally{try{!o&&f.return&&f.return()}finally{if(u)throw c}}if(0==h)return!1}}catch(t){r=!0,s=t}finally{try{!n&&a.return&&a.return()}finally{if(r)throw s}}return!0}function matchClass(t,e,n,r){if("*"==r)return 0;var s=r.match(/^[^\.#\[\]\s]+/),i=r.match(/\.[^\.#\[\]\s]+/g),a=r.match(/#[^\.#\[\]\s]+/g);return a?_matchId(n,a)?i&&!_matchClass(e,i)||s&&t!=s[0]?-1:2:-1:i?_matchClass(e,i)?s&&t!=s[0]?-1:1:-1:s&&t==s[0]?0:-1}function isBlankChar(t){return" "==t||"\t"==t||"\r"==t||"\n"==t||"\v"==t||"\f"==t}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),userAgentStyles=require("./config.js").userAgentStyles,CssHandler=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,t),this.styles=Object.assign({},e)}return _createClass(t,[{key:"getStyle",value:function(t){var e="";return t=t.replace(/<[sS][tT][yY][lL][eE][\s\S]*?>([\s\S]*?)<\/[sS][tT][yY][lL][eE][\s\S]*?>/g,function(){return e+=arguments[1],""}),this.styles=new CssParser(e,this.styles).parse(),t}},{key:"parseCss",value:function(t){return new CssParser(t,{},!0).parse()}},{key:"match",value:function(t,e,n){var r=[];if(e.class){var s=e.class.split(/\s/),i=!0,a=!1,l=void 0;try{for(var h,o=s[Symbol.iterator]();!(i=(h=o.next()).done);i=!0){var u=h.value;r.push("."+u)}}catch(t){a=!0,l=t}finally{try{!i&&o.return&&o.return()}finally{if(a)throw l}}}var c=[];if(e.id){var s=e.id.split(/\s/),d=!0,f=!1,y=void 0;try{for(var v,_=s[Symbol.iterator]();!(d=(v=_.next()).done);d=!0){var u=v.value;c.push("#"+u)}}catch(t){f=!0,y=t}finally{try{!d&&_.return&&_.return()}finally{if(f)throw y}}}var p,g,m="",S="",C="",k=!1;n.i=[],n.index=[],n.pseudo=[];for(var u=0;u<this.styles.length;u++){g=this.styles[u],">"==g.key[0]?(p=g.key.substring(1),k=!0):(p=g.key,k=!1);var x=matchClass(t,r,c,p);-1!=x&&(g.hasOwnProperty("index")&&g.index!=g.list.length-1?(n.i.push(u),n.index.push(g.index),g.index++,g.key=g.list[g.index]):g.pseudo?n.pseudo.push(g):0==x?m+=";"+g.content:1==x?S+=";"+g.content:C+=";"+g.content),k&&(n.i.push(u),n.index.push(g.index),g.index--,g.key=g.list[g.index])}return n.i.length||(delete n.i,delete n.index),n.pseudo.length||delete n.pseudo,(m?m+";":"")+(S?S+";":"")+(C?C+";":"")}},{key:"pop",value:function(t){if(t.hasOwnProperty("i")){for(var e=0;e<t.i.length;e++)this.styles[t.i[e]].key=this.styles[t.i[e]].list[t.index[e]],this.styles[t.i[e]].index=t.index[e];delete t.i,delete t.index}if(t.hasOwnProperty("pseudo")){var n=!0,r=!1,s=void 0;try{for(var i,a=t.pseudo[Symbol.iterator]();!(n=(i=a.next()).done);n=!0){var l,h=i.value,o=h.content.replace(/content\s*:\s*['"]([\S]*?)['"];*/,function(){return l=arguments[1],""}),u={name:"span",attrs:{style:o},children:[{type:"text",text:l}]};"before"==h.pseudo?t.children.unshift(u):t.children.push(u)}}catch(t){r=!0,s=t}finally{try{!n&&a.return&&a.return()}finally{if(r)throw s}}}}}]),t}(),CssParser=function(){function t(e,n,r){_classCallCheck(this,t),this.data=e,this.res=this.merge(n,r),this._floor=0,this._i=0,this._name="",this._content="",this._sectionStart=0,this._stateHandler=this.SpaceHandler}return _createClass(t,[{key:"merge",value:function(t,e){if(!e)for(var n in userAgentStyles)t[n]?t[n]=userAgentStyles[n]+";"+t[n]:t[n]=userAgentStyles[n];var r=[];for(var s in t)r.push({key:s,content:t[s]});return r}},{key:"parse",value:function(){for(;this._i<this.data.length;this._i++)this._stateHandler(this.data[this._i]);return this.res}},{key:"SpaceHandler",value:function(t){"."==t||"#"==t||t>="a"&&t<="z"||t>="A"&&t<="Z"?(this._sectionStart=this._i,this._stateHandler=this.StyleNameHandler):"/"==t&&"*"==this.data[this._i+1]?this.CommentHandler():isBlankChar(t)||";"==t||(this._stateHandler=this.IgnoreHandler)}},{key:"CommentHandler",value:function(){this._i=this.data.indexOf("*/",this._i),-1==this._i&&(this._i=this.data.length),this._i++,this._stateHandler=this.SpaceHandler}},{key:"IgnoreHandler",value:function(t){"{"==t?this._floor++:"}"==t&&--this._floor<=0&&(this._stateHandler=this.SpaceHandler)}},{key:"StyleNameHandler",value:function(t){"{"==t?(this._name=this.data.substring(this._sectionStart,this._i),this._sectionStart=this._i+1,this.ContentHandler()):isBlankChar(t)?(this._name=this.data.substring(this._sectionStart,this._i),this._stateHandler=this.NameSpaceHandler):"["==t&&(this._stateHandler=this.IgnoreHandler)}},{key:"NameSpaceHandler",value:function(t){"{"==t?(this._sectionStart=this._i+1,this.ContentHandler()):isBlankChar(t)||(this._stateHandler=this.StyleNameHandler)}},{key:"ContentHandler",value:function(){this._i=this.data.indexOf("}",this._i),-1==this._i&&(this._i=this.data.length);for(var t,e=!1,n=this.data.substring(this._sectionStart,this._i),r=0;r<n.length;r++)isBlankChar(n[r])?e||(t=r,e=!0):e&&(0==t?n=n.substring(r):r-t>1&&(n=n.substring(0,t)+(";"==n[t-1]?(t--,""):" ")+n.substring(r)),r=t,e=!1);e&&(n=n.substring(0,t)),this._content=n;var s=this._name.split(/\s*,\s*/),i=!0,a=!1,l=void 0;try{for(var h,o=s[Symbol.iterator]();!(i=(h=o.next()).done);i=!0){var u=h.value;this.setClass(u)}}catch(t){a=!0,l=t}finally{try{!i&&o.return&&o.return()}finally{if(a)throw l}}this._stateHandler=this.SpaceHandler}},{key:"setClass",value:function(t){var e;if(t.includes(":")){var n=t.split(/\s*:+\s*/);if(t=n[0],"before"!=(e=n[1])&&"after"!=e)return}/[\s>]/.test(t)?(t=t.replace(/\s*>\s*/g," >").split(/\s/),this.res.push({key:t[0],index:0,list:t,content:this._content,pseudo:e})):this.res.push({key:t,content:this._content,pseudo:e})}}]),t}();module.exports=CssHandler;